{% load static %}
{% load bootstrap4 %}

{% for movie in page_obj %}
<div class="col-12 col-md-6 col-lg-3 mb-3">
  <div class="card h-100">
  <!-- 영화 이미지 -->
    <a href="{% url 'movies:detail' movie.pk %}">
      {% if movie.poster_path %}
      <img src="https://image.tmdb.org/t/p/w342/{{ movie.poster_path }}" alt="{{ movie.title }}" class=" card-img-top ReSizeImage">
      {% else %}
      <img src="{% static 'image/noimage_index.png' %}" alt="{{ movie.title }}" class=" card-img-top ReSizeImage">
      {% endif %}
    </a>
    <!-- 영화 제목, 좋아요, 평점, 개봉일 -->
    <div class="card-body">
      <div class="d-flex justify-content-between">
          <div>
            <!-- 영화 제목, 평점 -->
            <a href="{% url 'movies:detail' movie.pk %}" class="font-weight-bold">{{ movie.title }}</a>
            <span><i class="fas fa-star fa-sm" style="color:crimson"> {{ movie.vote_average }}</i></span>
          </div>
          <div>
            <!-- 영화 좋아요 -->
          {% if request.user in movie.liked_users.all %}
              <i class="fas fa-heart fa-lg like-button" style="color:crimson" data-id="{{ movie.pk }}"></i>
              <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
          {% else %}
              <i class="fas fa-heart fa-lg like-button" style="color:black" data-id="{{ movie.pk }}"></i>
              <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
          {% endif %}
          </div>
      </div>
      <!-- 개봉일 -->
      <p class="mt-2 mb-0"><small>{{ movie.release_date|date:"Y-m-d" }} 개봉</small></p>
        
    </div>

  </div>
</div>
{% endfor %}
{% block script %}
  <script>
      $(document).ready(function(){
          $('.ReSizeImage').each(function(){
              var width = $(this).innerWidth()
              var ratio = 1.5
              $(this).innerHeight(width*ratio)

          })
      })
      var likeButtonList = document.querySelectorAll('.like-button')

      likeButtonList.forEach((likeButton) => {
          likeButton.addEventListener('click', function(event){
              const movieId = event.target.dataset.id

              axios.get(`/movies/${movieId}/like/`)
              .then((response) => {
                  // response.data.count -> json으로 응답(해당 게시글에 좋아요를 누른 사람의 수)
                  document.querySelector(`#like-count-${movieId}`).innerText = response.data.count

                  if (response.data.movie_liked) {
                      event.target.style.color = 'crimson'
                  } else {
                      event.target.style.color = 'black'
                  }
              })
            .catch((error) => {
                  console.log(error)
              })
          })
      })
  </script>
{% endblock %}