{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}

{% block title %}
{% endblock %}

{% block style %}
<style>
  #ToTopButton{
      position: fixed;
      right: 2%;
      bottom: 50px;
      display: none;
      z-index: 999;
  }
  </style>
{% endblock %}


{% block context %}
<!-- TOP BUTTON -->
  <a href="#myPage" title="To Top">
    <i class="w3-button w3-circle w3-teal fas fa-chevron-up" id="ToTopButton"></i>
  </a>
<!-- CONTEXT -->
<div class="container mt-5 mb-3 pb-3 d-flex justify-content-between w3-border-bottom"> 
  <div class="row d-flex flex-fill">
    <h3 class="mr-5"><i class="fas">전체 영화</i></h3>
    <div>
    <input id="mySearch" class="w3-input w3-border w3-animate-input" placeholder="Search" type="text">
  </div>
  </div>
  <div class="align-self-end">
    <a href="{% url 'movies:index_sort' 'rank' %}" class="mr-2 text-dark"><i class="fas fa-check">평점순</i></a> 
    <a href="{% url 'movies:index_sort' 'release' %}" class="mr-2 text-dark"><i class="fas fa-check">개봉순</i></a>
  </div>    
</div>

<!-- 영화 목록 - poster_path, adult, title, vote_average, released_date -->
<div class="container">
  <div class="row" id="movie_list">
    {% for movie in page_obj %}
      <div class="col-12 col-md-6 col-lg-3 mb-3">
        <div class="card h-100">
        <!-- 영화 이미지 -->
          <a href="{% url 'movies:detail' movie.pk %}">
            {% if movie.poster_path %}
            <img src="https://image.tmdb.org/t/p/w342/{{ movie.poster_path }}" alt="{{ movie.title }}" class=" card-img-top ReSizeImage">
            {% else %}
            <img src="{% static 'image/noimage_index.png' %}" alt="{{ movie.title }}" class=" card-img-top ReSizeImage">
            {% endif %}
          </a>
          <!-- 영화 제목, 좋아요, 평점, 개봉일 -->
          <div class="card-body">
            <div class="d-flex justify-content-between">
                <div>
                  <!-- 영화 제목, 평점 -->
                  <a href="{% url 'movies:detail' movie.pk %}" class="font-weight-bold MovieTitle">{{ movie.title }}</a>
                  <span><i class="fas fa-star fa-sm" style="color:crimson"> {{ movie.vote_average }}</i></span>
                </div>
                <div>
                  <!-- 영화 좋아요 -->
                {% if request.user in movie.liked_users.all %}
                    <i class="fas fa-heart fa-lg like-button" style="color:crimson" data-id="{{ movie.pk }}"></i>
                    <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                {% else %}
                    <i class="fas fa-heart fa-lg like-button" style="color:black" data-id="{{ movie.pk }}"></i>
                    <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                {% endif %}
                </div>
            </div>
            <!-- 개봉일 -->
            <p class="mt-2 mb-0"><small>{{ movie.release_date|date:"Y-m-d" }} 개봉</small></p>
              
          </div>

        </div>
      </div>
    {% endfor %}
  </div>
</div>

<!-- Pagination -->

<script>
  
$(document).ready(function(){
  // 무한스크롤
    const BASEURL = $(location).attr('pathname')  
    var page = 1
    $(window).scroll(function() {
        if ($(window).scrollTop() >= $(document).height() - $(window).height() - 2) {
          page++
          axios.get(BASEURL + `?page=${page}`)
          .then((res) => {
            $('#movie_list').append(res.data)
          })
        }
    });
    // TOP BUTTON
    $(window).scroll(function() {
          if ($(this).scrollTop() > 500) {
              $('#ToTopButton').fadeIn();
          } else {
              $('#ToTopButton').fadeOut();
          }
      });


    $("#ToTopButton").click(function(event) {
        $('html, body').animate({
            scrollTop: 0
        }, 400);
        return false
    })

    // searchbar
    $("#mySearch").on("keyup", function() {
      var inputValue = $(this).val()
      console.log(inputValue)
      $('.MovieTitle').filter(function(){
        console.log($(this).text())
        console.log($(this).toggle($(this).text().toLowerCase().indexOf(inputValue) > -1))
        $(this).toggle($(this).text().toLowerCase().indexOf(inputValue) > -1)
      })
    })


    // 이미지 사이즈 조절
    $('.ReSizeImage').each(function(){
        var width = $(this).innerWidth()
        var ratio = 1.5
        $(this).innerHeight(width*ratio)

    })
  })
  // 좋아요
  const likeButtonList = document.querySelectorAll('.like-button')

  likeButtonList.forEach((likeButton) => {
    likeButton.addEventListener('click', function(event){
      const movieId = event.target.dataset.id

      axios.get(`/movies/${movieId}/like/`)

      .then((response) => {
        // response.data.count -> json으로 응답(해당 게시글에 좋아요를 누른 사람의 수)
        document.querySelector(`#like-count-${movieId}`).innerText = response.data.count

        if (response.data.movie_liked) {
          event.target.style.color = 'crimson'
        } else {
          event.target.style.color = 'black'
        }
      })
      .catch((error) => {
        console.log(error)
      })
    })
  })
  </script>
{% endblock %}