{% extends 'base.html' %}
{% load bootstrap4 %}

{% block title %}
{% endblock %}
<style>

</style>
{% block context %}
<a href="{%url 'movies:index' %}" class="text-dark"><i class="fas fa-angle-double-left"></i></a>
<i class="fas"> 영화 상세 </i>
<hr>
<div class="container">
  <!-- 영화 줄거리 외 -->
  <div class="row">
    <span>
      <!-- w185xh278 -->
      <img src="https://image.tmdb.org/t/p/w185/{{ movie.poster_path }}" 
           style="width: 185px; height: 278px; overflow:hidden;"
           alt="Alps">
    </span>
    
    <div class="ml-4 mt-1">
      <!-- 제목 -->
      <h4>{{ movie.title }}</h4>
      <!-- origin제목 & 평점 -->
      <div class="mb-1">
        <span><small>{{ movie.original_title }}</small></span> |
        <span><i class="fas fa-star fa-sm" style="color:crimson"> {{ movie.vote_average }}</i></span>
      </div>
      <!-- 장르, 국가 -->
      <div class="mb-1">
        <span id="genre">
          {% for genre in movie.genres.all %}
            {{ genre.name }}
          {% endfor %}
        </span> |
        <span id="language">
          {{ movie.original_language }}
        </span>
      </div class="mb-1">
      <!-- 개봉일 -->
      <div class="mb-3">
        <span>{{ movie.release_date }} 개봉 </span>
      </div>
      <a href="" class="btn btn-primary">예고편</a>
    </div>
  </div>
  <!-- 영화 줄거리 -->
  <div class="row mt-4 d-flex flex-column">
    <div class="block"><i class="fas"> 줄거리</i></div>
    <hr>
    <p>{{ movie.overview }}</p>
  </div>
</div>


<form action="{% url 'movies:review_create' movie.pk %}" method="POST">
    {% csrf_token %}
    {% bootstrap_form form %}
    <button>작성</button>
</form>
<hr>
{{ reviews|length }}의 댓글
<hr>
{% for review in reviews %}
    <p>{{ review.rank }}</p>
    {% if request.user in review.liked_users.all %}
        <i class="fas fa-heart fa-lg like-button" style="color:crimson" data-id="{{ review.pk }}" data-movie-id="{{ movie.pk }}"></i>
    {% else %}
        <i class="fas fa-heart fa-lg like-button" style="color:black" data-id="{{ review.pk }}" data-movie-id="{{ movie.pk }}"></i>
    {% endif %}
    <p>{{ review.author }} : {{ review.content }}</p>
    <p>좋아요 : <span id="like-count-{{ review.pk }}">{{ review.liked_users.all|length }}</span></p>
    <small>
        <form action="{% url 'movies:review_delete' movie.pk review.pk %}" method="POST" class="d-inline">
            {% csrf_token %}
        <button style="border:0; background-color: transparent" class="text-decoration-none">삭제</button>
        </form>
    </small>
    <hr>
{% empty %}
    <p>새 리뷰를 작성해주세요</p>
{% endfor %}


<script>
  // 장르
  var genres = document.getElementById('genre').innerText
  document.getElementById('genre').innerText = genres.split(" ")[0] 
  
  // 국가
  const contries = {
    'ja': '일본',
    'en': '미국',
    'fr': '프랑스',
    'sv': '엘셀바도르',
    'ru': '러시아',
    'ko': '한국',
    'it': '이탈리아',
    'pt': '포르투갈',
    'cn': '중국',
    'es': '스페인',
    'hi': '인도',
    'cs': '체코',
    'zh': '중국',
    'da': '덴마크',
    'ar': '아르헨티나',
    'id': '인도네시아',
    'el': '그리스',
    'th': '태국',
    'tr': '터키',
    'de': '독일',
    'fa': '이란',
    'no': '노르웨이',
    'ml': '인도',
    'pl': '폴란드',
    'uk': '우크라이나',
  }
  const language = document.getElementById('language').innerText
  document.getElementById('language').innerText = contries[language]

  // 좋아요
  const likeButtonList = document.querySelectorAll('.like-button')

  likeButtonList.forEach((likeButton) => {
    likeButton.addEventListener('click', function(event){
      const reviewId = event.target.dataset.id
      const movieId = event.target.dataset.movieId

      axios.get(`/movies/${movieId}/review/${reviewId}/like/`)

      .then((response) => {
        // response.data.count -> json으로 응답(해당 게시글에 좋아요를 누른 사람의 수)
        document.querySelector(`#like-count-${reviewId}`).innerText = response.data.count

        if (response.data.liked) {
          event.target.style.color = 'crimson'
        } else {
          event.target.style.color = 'black'
        }
      })
      .catch((error) => {
        console.log(error)
      })
    })
  })
</script>

{% endblock %}