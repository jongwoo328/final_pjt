{% extends 'base.html' %}
{% load bootstrap4 %}
{% load static %}

{% block title %}
{% endblock %}

{% block head %}
<link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<style>
    .movie-title {
        height: 44px;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    hr {
        background-color: white;
        margin-top: 0px;
    }
</style>
{% endblock %}

{% block style %}
<style>
.scrollmenu {
    overflow: auto;
    white-space: nowrap;
}
.card-body {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  width: 158px;
  height: 100px;
}
.movie_card{
    display:inline-block;
}
#ToTopButton{
    position: fixed;
    right: 2%;
    bottom: 50px;
    display: none;
    z-index: 999;
}
</style>
    
{% endblock %}

{% block context %}

    {% if request.user.is_authenticated %}
        <div class="mb-5">
            <div class="d-flex">
                <h3 class="mb-0"><i class="fas">추천 영화</i></h3>
                {% if not liked %}
                    <div class="ml-auto">
                        <p class="d-inline-block mr-2">영화를 <span style="color: crimson;">좋아요</span> 하면 관련있는 영화를 추천받을 수 있습니다.</p>
                        <a class="w3-button text-decoration-none" href="{% url 'movies:index' %}" style="background-color: #4c6b8d; color:white;">찾아보러 가기</a>
                    </div>
                {% endif %}
            </div>
            <div class="container-fulid mx-0 px-0 scrollmenu" >
                {% for movie in recommends %}
                    {% if movie.poster_path %}
                    <div class="card movie_card">
                        <!-- 영화 이미지 -->
                        <!-- <a href="{% url 'movies:detail' movie.pk %}"> -->
                        <img src="https://image.tmdb.org/t/p/w185{{ movie.poster_path }}" alt="{{ movie.title }}" class="card-img-top">
                            
                        <!-- </a> -->
                        <div class="card-body">
                            <!-- 영화 제목 -->
                            <a href="{% url 'movies:detail' movie.pk %}" class="text-dark text-decoration-none">{{ movie.title }}</a>
                            <hr>
                            <div class="container-fluid px-0">
                                <div class="d-flex justify-content-between">
                                    <div class="flex-fill">
                                        <span><i class="fas fa-star" style="color:crimson">{{ movie.vote_average }}</i></span>
                                    </div>
                                    <div>
                                        {% if request.user in movie.liked_users.all %}
                                            {% if request.user.is_authenticated %}
                                                <i class="fas fa-heart like-button align-self-center" style="color:crimson" data-id="{{ movie.pk }}"></i>
                                            {% else %}
                                                <i class="fas fa-heart align-self-center" style="color:crimson" onclick="alert('로그인이 필요합니다.')"></i>
                                            {% endif %}
                                        {% else %}
                                            {% if request.user.is_authenticated %}
                                                <i class="fas fa-heart like-button align-self-center" style="color:black" data-id="{{ movie.pk }}"></i>
                                            {% else %}
                                                <i class="fas fa-heartalign-self-center" style="color:black" onclick="alert('로그인이 필요합니다.')"></i>
                                            {% endif %}
                                        {% endif %}
                                        <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                                    </div>
                                </div>

                            </div>
                        </div>
                        
                    </div>
                    {% endif %}
                
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <div class="mb-5">
        <div class="d-flex my-2">
        <h3 class="mb-0"><i class="fas">인기 영화</i></h3>
        </div>
        <div class="container-fulid mx-0 px-0 scrollmenu" >
            {% for movie in popular_movies %}
                {% if movie.poster_path %}
                <div class="card movie_card">
                    <!-- 영화 이미지 -->
                    <!-- <a href="{% url 'movies:detail' movie.pk %}"> -->
                    <img src="https://image.tmdb.org/t/p/w185{{ movie.poster_path }}" alt="{{ movie.title }}" class="card-img-top">
                        
                    <!-- </a> -->
                    <div class="card-body">
                        <!-- 영화 제목 -->
                        <a href="{% url 'movies:detail' movie.pk %}" class="text-dark text-decoration-none">{{ movie.title }}</a>
                        <hr>
                        <div class="container-fluid px-0">
                            <div class="d-flex justify-content-between">
                                <div class="flex-fill">
                                    <span><i class="fas fa-star" style="color:crimson">{{ movie.vote_average }}</i></span>
                                </div>
                                <div>
                                    {% if request.user in movie.liked_users.all %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:crimson" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heart align-self-center" style="color:crimson" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% else %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:black" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heartalign-self-center" style="color:black" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% endif %}
                                    <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                </div>
                {% endif %}
            
            {% endfor %}
        </div>
    </div>


    <div class="mb-5">
        <div class="d-flex my-2">
        <h3 class="mb-0"><i class="fas">새로운 영화</i></h3>
        </div>
        <div class="container-fulid mx-0 px-0 scrollmenu" >
            {% for movie in new_movies %}
                {% if movie.poster_path %}
                <div class="card movie_card">
                    <!-- 영화 이미지 -->
                    <!-- <a href="{% url 'movies:detail' movie.pk %}"> -->
                    <img src="https://image.tmdb.org/t/p/w185{{ movie.poster_path }}" alt="{{ movie.title }}" class="card-img-top">
                        
                    <!-- </a> -->
                    <div class="card-body">
                        <!-- 영화 제목 -->
                        <a href="{% url 'movies:detail' movie.pk %}" class="text-dark text-decoration-none">{{ movie.title }}</a>
                        <hr>
                        <div class="container-fluid px-0">
                            <div class="d-flex justify-content-between">
                                <div class="flex-fill">
                                    <span><i class="fas fa-star" style="color:crimson"> </i>
                                         <strong>{{ movie.vote_average }}</strong>
                                        </span>
                                </div>
                                <div>
                                    {% if request.user in movie.liked_users.all %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:crimson" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heart align-self-center" style="color:crimson" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% else %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:black" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heartalign-self-center" style="color:black" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% endif %}
                                    <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                </div>
                {% endif %}
            {% endfor %}
        </div>

    </div>

    <div class="mb-5">
        <h3 class="mb-0"><i class="fas">이런 영화는 어떠세요?</i></h3>
        <div class="container-fulid mx-0 px-0 scrollmenu" >
            {% for movie in movies %}
                {% if movie.poster_path %}
                <div class="card movie_card">
                    <!-- 영화 이미지 -->
                    <!-- <a href="{% url 'movies:detail' movie.pk %}"> -->
                    <img src="https://image.tmdb.org/t/p/w185{{ movie.poster_path }}" alt="{{ movie.title }}" class="card-img-top">
                        
                    <!-- </a> -->
                    <div class="card-body">
                        <!-- 영화 제목 -->
                        <a href="{% url 'movies:detail' movie.pk %}" class="text-dark text-decoration-none">{{ movie.title }}</a>
                        <hr>
                        <div class="container-fluid px-0">
                            <div class="d-flex justify-content-between">
                                <div class="flex-fill">
                                    <span><i class="fas fa-star" style="color:crimson">{{ movie.vote_average }}</i></span>
                                </div>
                                <div>
                                    {% if request.user in movie.liked_users.all %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:crimson" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heart align-self-center" style="color:crimson" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% else %}
                                        {% if request.user.is_authenticated %}
                                            <i class="fas fa-heart like-button align-self-center" style="color:black" data-id="{{ movie.pk }}"></i>
                                        {% else %}
                                            <i class="fas fa-heartalign-self-center" style="color:black" onclick="alert('로그인이 필요합니다.')"></i>
                                        {% endif %}
                                    {% endif %}
                                    <span id="like-count-{{ movie.pk }}">{{ movie.liked_users.all|length }}</span>
                                </div>
                            </div>

                        </div>
                    </div>
                    
                </div>
                {% endif %}
            
            {% endfor %}
        </div>
    </div>

{% endblock %}

{% block script %}
<script>
$(document).ready(function(){
    // 이미지 사이즈
    const width = 158
    const height = 158* 1.5
    $(".card-img-top").css("width", width)
    $(".card-img-top").css("height", height)

    // Top Button
    $(window).scroll(function() {
            if ($(this).scrollTop() > 500) {
                $('#ToTopButton').fadeIn();
            } else {
                $('#ToTopButton').fadeOut();
            }
        });

    $("#ToTopButton").click(function(event) {
        $('html, body').animate({
            scrollTop: 0
        }, 400);
        return false
    })
})
$('.like-button').on('click',function(event){
      const movieId = event.target.dataset.id
      if (movieId !== undefined) {
        axios.get(`/movies/${movieId}/like/`)

        .then((response) => {

          document.querySelector(`#like-count-${movieId}`).innerText = response.data.count

          if (response.data.movie_liked) {
            event.target.style.color = 'crimson'
          } else {
            event.target.style.color = 'black'
          }
        })
        .catch((error) => {
          console.log(error)
        })
      }
    })
</script>
{% endblock %}